var app=function(t){"use strict";function e(t){return[Math.round(t[0]),Math.round(t[1])]}function i(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function s(t,e,i=1){return[t[0]+e[0]*i,t[1]+e[1]*i]}function h(t){let e=a(t)||1;return[t[0]/e,t[1]/e]}function a(t,e){return i(e?[t[0]-e[0],t[1]-e[1]]:t)}function n(t,e){return[e[0]-t[0],e[1]-t[1]]}function r(t,e){return t[0]*e[0]+t[1]*e[1]}function o(t,e){return[t[0]*e,t[1]*e]}function l(t,e,s,a){let o=n(e,s),l=[(c=h(o))[1],-c[0]];var c;let d=n(e,t),g=i(o),f=r(o,d)/g,u=r(l,d);return Math.abs(u)<=a&&0<=f&&f<=g}function c(t,e,i=1){let s=a(t,e),h=[];for(let a=0;a<=s;a+=i)h.push(d(t,e,a));return h}function d(t,e,i){return[t[0]*(1-i)+i*e[0],t[1]*(1-i)+i*e[1]]}function g(t){return[Math.cos(t),Math.sin(t)]}class f{constructor(t){this.dots=[],this.length=0,Object.assign(this,t)}updateLength(){this.length=this.dots.reduce((t,e,i)=>0==i?0:t+a(this.dots[i-1],e),0)||0}enlarge(t){let e=this.dots;for(e.push(t),this.updateLength();this.length>this.maxLength||e.length>30;)e.shift(),this.updateLength()}compact(t,e){for(;t.dots.length>=3&&a(t.head,t.dots[t.dots.length-2])<=e;)t.dots.splice(t.dots.length-2,1)}get head(){return this.dots[this.dots.length-1]}draw(t,i){let s=this.dots;t.save(),t.lineCap="round";for(let h=1;h<s.length;h++){let a=s[h],n=s[h-1];t.beginPath(),t.moveTo(...e(n)),i&&i(this,h),t.lineTo(...e(a)),t.stroke()}t.restore()}drawSmooth(t){if(this.dots.length<2)return;let e=this.dots;t.save(),t.beginPath(),t.moveTo(...e[0]),t.lineCap="round";for(let i=1;i<e.length-1;i++){let h=e[i],a=e[i-1],n=o(s(a,h),.5);t.quadraticCurveTo(a[0],a[1],n[0],n[1])}t.quadraticCurveTo(e[e.length-2][0],e[e.length-2][1],e[e.length-1][0],e[e.length-1][1]),t.stroke(),t.restore()}width(t){return 4}hitTest(t){let e=this.dots;for(let i=1;i<e.length;i++){let s=e[i],a=e[i-1];if(l(t,a,s,this.width(4)))return h(n(a,s))}return null}loseHead(){this.dots.length>=3&&(this.dots.pop(),this.updateLength())}}class u{constructor(t){this.game=t,this.hurt=0,this.maxLength=150,this.tail=new f({maxLength:this.maxLength,maxDots:30})}get length(){return this.tail.maxLength}update(t,e){let i;t&&this.tail.enlarge(t);for(let t of this.tail.dots)if(i=this.game.foeHit(t))break;i&&(i.damage(),this.tail.loseHead(),this.tail.maxLength=Math.max(10,this.tail.maxLength-10),this.hurt=1,this.game.delayed(.2,()=>{this.hurt=0})),this.tail.maxLength<=this.maxLength&&(this.tail.maxLength+=e*this.game.snakeRecoverRate)}draw(){if(this.tail.dots.length<2)return;let t=this.game.ctx;t.save(),this.hurt&&Math.floor(20*this.game.time)%2?(t.strokeStyle="red",t.shadowColor="red"):(t.strokeStyle="white",t.shadowColor="white"),t.shadowBlur=6,t.lineWidth=10,this.tail.drawSmooth(this.game.ctx);let e=this.head;t.lineWidth=0,t.fillStyle=`rgba(255,255,255, ${.2*(1.2+Math.sin(2*this.game.time))})`,t.beginPath(),t.arc(e[0],e[1],10,0,2*Math.PI),t.fill(),t.restore()}get head(){return this.tail.head}}class m{constructor(){this.events=[]}add(t,e){for(let i=this.events.length-1;i>0;i--)if(this.events[i][1]<=t)return void this.events.splice(i+1,0,[e,t]);this.events.splice(0,0,[e,t])}update(t){for(;this.events.length>0&&this.events[0][1]<=t;){let e=this.events.shift(),i=e[0](t);(i||0==i)&&this.add(i+t,e[0])}}}class w{constructor(t,e,i,s,h,a){this.object=t,this.field=e,this.target=i,this.duration=s,this.initialTime=h,this.fun=a,this.initial=t[e]}update(t){let e=(t-this.initialTime)/this.duration;return e>=1?(this.object[this.field]=this.target,this.onEnd&&this.onEnd(),!1):(this.fun&&(e=this.fun(e)),this.object[this.field]=this.initial+(this.target-this.initial)*e,!0)}}class v{constructor(t){this.time=t,this.tweens=[]}update(t){this.time=t,this.tweens=this.tweens.filter(e=>e.update(t))}add(t,e,i,s){let h=new w(t,e,i,s,this.time);return this.tweens.push(h),h}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var p,k=(function(t){function e(){this.setSettings=function(t){for(var e=0;e<24;e++)this[String.fromCharCode(97+e)]=t[e]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;if(i<.18){var s=.18/i;this.b*=s,this.c*=s,this.e*=s}}}var i=new function(){var t,i,s,h,a,n,r,o,l,c,d,g;this._params=new e,this.reset=function(){var t=this._params;h=100/(t.f*t.f+.001),a=100/(t.g*t.g+.001),n=1-t.h*t.h*t.h*.01,r=-t.i*t.i*t.i*1e-6,t.a||(d=.5-t.n/2,g=5e-5*-t.o),o=1+t.l*t.l*(t.l>0?-.9:10),l=0,c=1==t.m?0:(1-t.m)*(1-t.m)*2e4+32},this.totalReset=function(){this.reset();var e=this._params;return t=e.b*e.b*1e5,i=e.c*e.c*1e5,s=e.e*e.e*1e5+12,3*((t+i+s)/3|0)},this.synthWave=function(e,f){var u=this._params,m=1!=u.s||u.v,w=u.v*u.v*.1,v=1+3e-4*u.w,p=u.s*u.s*u.s*.1,k=1+1e-4*u.t,b=1!=u.s,x=u.x*u.x,M=u.g,S=u.q||u.r,T=u.r*u.r*u.r*.2,A=u.q*u.q*(u.q<0?-1020:1020),L=u.p?32+((1-u.p)*(1-u.p)*2e4|0):0,P=u.d,I=u.j/2,y=u.k*u.k*.01,E=u.a,C=t,H=1/t,W=1/i,R=1/s,N=5/(1+u.u*u.u*20)*(.01+p);N>.8&&(N=.8),N=1-N;for(var O,B,D,U,G,$,F=!1,X=0,j=0,q=0,_=0,z=0,K=0,V=0,Y=0,J=0,Q=0,Z=new Array(1024),tt=new Array(32),et=Z.length;et--;)Z[et]=0;for(et=tt.length;et--;)tt[et]=2*Math.random()-1;for(et=0;et<f;et++){if(F)return et;if(L&&++J>=L&&(J=0,this.reset()),c&&++l>=c&&(c=0,h*=o),(h*=n+=r)>a&&(h=a,M>0&&(F=!0)),B=h,I>0&&(Q+=y,B*=1+Math.sin(Q)*I),(B|=0)<8&&(B=8),E||((d+=g)<0?d=0:d>.5&&(d=.5)),++j>C)switch(j=0,++X){case 1:C=i;break;case 2:C=s}switch(X){case 0:q=j*H;break;case 1:q=1+2*(1-j*W)*P;break;case 2:q=1-j*R;break;case 3:q=0,F=!0}S&&((D=0|(A+=T))<0?D=-D:D>1023&&(D=1023)),m&&v&&((w*=v)<1e-5?w=1e-5:w>.1&&(w=.1)),$=0;for(var it=8;it--;){if(++V>=B&&(V%=B,3==E))for(var st=tt.length;st--;)tt[st]=2*Math.random()-1;switch(E){case 0:G=V/B<d?.5:-.5;break;case 1:G=1-V/B*2;break;case 2:G=.225*(((G=1.27323954*(U=6.28318531*((U=V/B)>.5?U-1:U))+.405284735*U*U*(U<0?1:-1))<0?-1:1)*G*G-G)+G;break;case 3:G=tt[Math.abs(32*V/B|0)]}m&&(O=K,(p*=k)<0?p=0:p>.1&&(p=.1),b?(z+=(G-K)*p,z*=N):(K=G,z=0),_+=(K+=z)-O,G=_*=1-w),S&&(Z[Y%1024]=G,G+=Z[(Y-D+1024)%1024],Y++),$+=G}$*=.125*q*x,e[et]=$>=1?32767:$<=-1?-32768:32767*$|0}return f}},s=function(t){i._params.setSettings(t);var e=i.totalReset(),s=new Uint8Array(4*((e+1)/2|0)+44),h=2*i.synthWave(new Uint16Array(s.buffer,44),e),a=new Uint32Array(s.buffer,0,44);a[0]=1179011410,a[1]=h+36,a[2]=1163280727,a[3]=544501094,a[4]=16,a[5]=65537,a[6]=44100,a[7]=88200,a[8]=1048578,a[9]=1635017060,a[10]=h,h+=44;for(var n=0,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="data:audio/wav;base64,";n<h;n+=3){var l=s[n]<<16|s[n+1]<<8|s[n+2];o+=r[l>>18]+r[l>>12&63]+r[l>>6&63]+r[63&l]}return o};t.exports=s}(p={exports:{}},p.exports),p.exports);function b(t,e=.01){let i=t.slice();i[23]*=.2*Math.random()+.8,i[5]*=Math.random()+.5,function(t){try{var e=k(t),i=new Audio;i.src=e,i.play()}catch(t){console.error(t)}}(i)}new AudioContext;function x(t){b([3,,.0315,,.1484,.496,,-.5938,,,,,,,,,,,1,,,.2325,,.5])}class M{constructor(t){this.game=t,t.fx.push(this)}update(t){return!1}draw(){}}class S{}class T extends M{constructor(t,e,i){super(t),this.at=e,this.life=0,this.particles=[],this.color=[255,255,255],this.arc=2*Math.PI,this.lifeTime=1,this.pnum=30,this.pvel=200,i&&Object.assign(this,i);let s=t.fxScale;for(let t=0;t<this.pnum;t++){let i=new S;this.particles.push(i),i.at=o(e,s);let h=t/this.pnum*Math.PI*2+.1*Math.random(),a=Math.random()*this.pvel;i.vel=o(g(h),a*s)}b([3,,.1238,.3385,.3229,.0203,,.0284,,,,,,,,,.4758,-.0269,1,,,,,.5])}update(t){for(let e of this.particles)e.at=s(e.at,e.vel,t);return this.life+=t/this.lifeTime,this.life<=1}draw(){let t=this.game.ctx;t.save(),t.lineWidth=1,t.strokeStyle=`rgba(${this.color.join()}, 1)`,t.fillStyle=`rgba(${this.color.join()}, ${.5-.5*(this.life||0)})`,t.beginPath(),t.arc(this.at[0],this.at[1],20*(1+2*this.life),0,2*Math.PI),t.stroke(),t.fill(),t.restore();let e=this.game.ctb,i=this.game.fxScale;e.save(),e.lineWidth=2*i,e.fillStyle=`rgba(${this.color[0]}, ${this.color[1]}, ${this.color[2]}, ${1-this.life})`;for(let t of this.particles)e.fillRect(t.at[0],t.at[1],4*i,4*i);e.restore()}}function A(t,e){return t[e()%t.length]}const L=30,P=6;let I=function(t,e){let i=document.createElement("canvas");return i.width=t[0],i.height=t[1],e(i.getContext("2d")),i}([20,20],t=>{t.filter="blur(2px)",t.fillStyle="rgba(255, 255, 255, 0.3)",t.beginPath(),t.arc(10,10,7,0,2*Math.PI),t.fill(),t.fillStyle="rgba(128, 128, 128, 0.6)",t.beginPath(),t.arc(10,10,3,0,2*Math.PI),t.fill()});class y{constructor(t,e,i,h=180){this.game=t,this.bounces=0,t.shots.push(this);let a=[-Math.sin(i),Math.cos(i)];this.tail=new f({dots:[s(e,a,10)],vel:o(a,h),maxLength:L,maxDots:P})}update(t){let e=this.tail,h=e.head;if(h[1]>this.game.height){if(this.phantom)return!1;new T(this.game,h,{color:[255,0,0]}),this.game.shieldHit()}if(h[0]<0||h[1]<0||h[0]>this.game.width||h[1]>this.game.height)return!1;let a,r=s(h,e.vel,t);if(this.bounces>0&&!this.phantom){let t=this.game.foeHit(r);if(t){if(2==t.kind){let e;for(e of c(h,r))if(t.hitTest(e))break;e=e||r;let i=n(t.at,e),s=Math.atan2(i[1],i[0]);s>.25*Math.PI&&s<.75*Math.PI||t.damage()}else t.damage();return!1}}let l,d=this.game.snake.tail;for(l of c(h,r,3))if(a=d.hitTest(l))break;return a?(x(this.tail.head),e.vel=o((f=e.vel,u=a,g(2*Math.atan2(u[1],u[0])+Math.atan2(f[1],-f[0])+Math.PI)),i(e.vel)),e.enlarge(s(l,e.vel,3*t)),this.bounces++,!0):(e.enlarge(r),!0);var f,u}draw(){let t=this.game.ctx;t.save();let i=e(this.tail.head);this.phantom||(t.drawImage(I,i[0]-10,i[1]-10),this.bounces>0&&t.drawImage(I,i[0]-10,i[1]-10)),t.lineWidth=4,t.strokeStyle="#ffdddd",this.tail.draw(t,(e,i)=>{let s=Math.min(i/this.tail.dots.length);t.strokeStyle=`rgb(255, 255, 255, ${s})`}),t.restore()}}class E extends M{constructor(t,e,i){super(t),this.foe=e,this.radius=i,this.time=0}update(t){return this.time+=t,this.time<1}draw(){let t=this.game.ctx;t.save(),t.beginPath(),t.lineWidth=2*(1-this.time),t.strokeStyle="white",t.arc(this.foe.at[0],this.foe.at[1],this.radius*(1+this.time),0,2*Math.PI),t.stroke(),t.restore()}}let C,H=.5,W={4:3,8:4.5};class R{constructor(t,e){this.wing=t,this.radius=20,this.charge=0,this.angle=0,this.kind=1,this.special=0,this.shields=0,Object.assign(this,e),this.game=t.game,this.order=t.foes.length,this.game.foes.push(this),t.foes.push(this)}get chargeTime(){return this.game.beatLength*(W[this.kind]||.5)}draw(){let t=this.game.ctx;if(t.save(),t.strokeStyle="#ffffff",t.translate(this.at[0],this.at[1]),t.scale(this.radius,this.radius),t.rotate(this.angle),!this.dying){t.fillStyle=`rgba(255,255,255,${Math.max(this.charge/2,0)})`,t.shadowColor="white",t.shadowBlur=5,t.lineWidth=.1,R.MIRAGE!=this.kind&&(t.beginPath(),t.arc(0,0,1,0,2*Math.PI),R.STEALTH!=this.kind&&t.stroke(),t.fill());for(let e=0;e<this.shields;e++)t.beginPath(),t.arc(0,0,1+.3*(e+1),0,2*Math.PI),t.stroke();t.save(),t.beginPath(),this.drawSignature(t),t.stroke(),t.restore()}if(t.restore(),t.save(),this.kind==R.COMM&&this.charge>.9){t.setLineDash([5,15]);for(let e of this.game.foes)e.kind!=R.COMM&&(t.strokeStyle="white",t.lineWidth=10*(this.charge-.9),t.beginPath(),t.moveTo(...this.at),t.lineTo(...e.at),t.stroke())}t.restore()}drawSignature(t){switch(this.kind){case R.SHIELD:t.beginPath(),t.arc(0,0,.5,0,2*Math.PI),t.stroke();case R.PAWN:return t.moveTo(0,1),void t.lineTo(0,.5);case R.WALL:return t.lineWidth=.2,void t.arc(0,0,.85,.25*Math.PI,.75*Math.PI);case R.SPAWN:if(this.special)return;t.lineWidth=.05;for(let e=0;e<3;e++)t.strokeStyle="black",t.shadowColor="black",t.beginPath(),t.arc(0,.5,.3,0,2*Math.PI),t.stroke(),t.rotate(2*Math.PI/3);return;case R.COMM:t.lineWidth=.05;for(let e=0;e<3;e++)t.beginPath(),t.arc(0,0,.35+.2*e,Math.PI,2*Math.PI),t.stroke();return;case R.FAN:for(let e=-2;e<=2;e++){let i=.3*e;t.moveTo(-Math.sin(i),Math.cos(i)),t.lineTo(.7*-Math.sin(i),.7*Math.cos(i))}return;case R.MIRAGE:return this.phantom&&Math.random()<.005&&(t.strokeStyle="rgba(255,255,255,0.5)"),t.moveTo(0,1),t.lineTo(0,.5),t.stroke(),t.beginPath(),t.arc(0,0,1,0,2*Math.PI),void t.fill();case R.BOMB:for(let e=0;e<=16;e++)t.moveTo(0,1+.3*this.charge),t.lineTo(0,.7+.3*this.charge),t.rotate(Math.PI/8);return;case R.CHASE:return t.moveTo(-.9,-.4),t.lineTo(0,.45),void t.lineTo(.9,-.4);case R.SNIPE:return t.moveTo(0,-.8),t.lineTo(0,1),t.moveTo(.2,-.8),t.lineTo(.2,1),t.moveTo(-.2,-.8),void t.lineTo(-.2,1)}}actuallyShoot(){switch(this.kind){case R.SPAWN:this.special?new y(this.game,this.at,this.angle):(this.vel[0]=this.vel[0]*(this.game.rni()%2?1:-1),new R(this.wing,{kind:3,at:this.at,vel:[-this.vel[0],this.vel[1]],special:!0}));break;case R.COMM:for(let t of this.game.foes)4!=t.kind&&t.shoot();break;case R.FAN:for(let t=-2;t<=2;t++){let e=.3*t;new y(this.game,this.at,e)}break;case R.MIRAGE:let t=new y(this.game,this.at,this.angle);this.phantom&&(t.phantom=!0);break;case R.BOMB:for(let t=0;t<16;t++)new y(this.game,this.at,Math.PI/8*t,500),this.explode();break;case R.SNIPE:for(let t=-1;t<=1;t++)new y(this.game,s(this.at,g(this.angle),5*t),this.angle,500);break;case R.CHASE:this.vel=o(g(this.angle+Math.PI/2),200);break;case R.SHIELD:this.shields<1?this.shields++:new y(this.game,this.at,this.angle);break;default:new y(this.game,this.at,this.angle)}this.charge=0}update(t){if(this.kind==R.CHASE){let t=n(this.at,this.game.snake.head);this.angle=Math.atan2(t[1],t[0])-Math.PI/2}this.dying&&(this.dying+=t/H),this.charge>0&&(this.charge+=t/this.chargeTime,this.charge>=1&&this.actuallyShoot());let e=s(this.at,this.vel,t);this.at=e,this.at[1]<-400&&this.remove()}get dead(){return this.dying>=1}shoot(){this.charge>0||this.kind==R.WALL||this.at[0]<0||([1,6,10,11,12].includes(this.kind)&&this.game.tweens.add(this,"angle",.5*(this.game.rnf()-.5),this.chargeTime-.1),this.charge=.01)}remove(){if(this.dying=.01,this.kind==R.MIRAGE&&!this.phantom)for(let t of this.wing.foes)t.phantom&&t.remove()}explode(){this.dying||(this.game.score+=Math.floor(this.game.shield),this.remove(),new T(this.game,this.at))}hitTest(t){return a(t,this.at)<=this.outerRadius?t:null}get phantom(){return this.kind==R.MIRAGE&&!this.special}damage(){this.shields>0?(new E(this.game,this,this.outerRadius),this.shields--):this.explode()}get outerRadius(){return this.radius*(1+.3*this.shields)}}function N(t,e){let i=t.conf,s=e%i.cols,h=Math.floor(e/i.cols),a=Math.min(40,(t.game.width-200)/i.cols),n=t.ind%2?t.game.width-100-i.cols*a:100,r=i.kind,o=h==i.rows-1;i.complication==X.WALL&&o&&(r=R.WALL);let l={at:[s*a+n,20-40*i.rows+40*h],vel:[t.ind%2?-10:10,30],shields:0,kind:r};return i.complication==X.SHIELD&&(l.shields=1),l}function O(t,e){let i=t.conf;return{at:[t.game.width/2-20*i.cols,40*Math.floor(e/i.rows)-80],vel:[40*t.game.rnf()-20,30],kind:i.kind}}function B(t,e){let i=e.wing.conf;t%(i.rows+1)!=i.rows&&Math.floor(e.order/i.cols)!=i.rows-t%(i.rows+1)||e.shoot()}function D(t,e){e.game.rni()%4&&e.game.delayed(e.game.beatLength*e.game.rnf(),()=>e.shoot())}function U(t,e){t%4&&e.game.delayed(2*e.game.beatLength*e.order/e.wing.size,()=>e.shoot())}function G(t,e){t%2==0&&e.shoot()}function $(t){(t.at[0]<100&&t.vel[0]<0||t.at[0]>=t.wing.game.width-100&&t.vel[0]>0)&&(t.vel[0]=-t.vel[0]),t.at[1]>=t.wing.game.height-300&&t.vel[1]>0&&(t.vel[1]=-t.vel[1])}function F(t){(t.at[0]<100&&t.vel[0]<0||t.at[0]>=t.wing.game.width-100&&t.vel[0]>0)&&(t.vel=[0,0]),(t.at[1]>=t.wing.game.height-100&&t.vel[1]>0||t.at[1]<=100&&t.vel[1]<0)&&(t.vel=[0,0])}R.PAWN=1,R.WALL=2,R.SPAWN=3,R.COMM=4,R.FAN=5,R.MIRAGE=6,R.SHIELD=7,R.BOMB=8,R.CHASE=9,R.SNIPE=10,R.STEALTH=11,R.SNAKE=12;class X{constructor(t,e,i){if(this.game=t,this.ind=e,this.skirmisher=i,this.foes=[],this.beat=0,i)this.conf={cols:1,rows:1,kind:A(X.skirmishUnlocks.slice(0,t.stage),t.rni),init:O,foeBeat:G,foeThink:$},this.conf.kind==R.CHASE&&(this.conf.foeThink=F);else if(this.conf={cols:4+Math.floor(t.complication/4),rows:3,kind:R.PAWN,init:N,foeBeat:B,foeThink:$},t.complicatedPhalanx())switch(this.conf.complication=A(X.phalanxUnlocks.slice(0,t.stage),t.rni),this.conf.complication){case X.H2X:case X.W2X:this.conf.rows*=2;break;case X.RANDOM:this.conf.foeBeat=D;break;case X.CONTINUOUS:this.conf.foeBeat=U;break;case X.PHALANX:this.conf.cols*=this.conf.rows,this.conf.rows=1}this.init(this.size,this.conf.init),this.conf.kind==R.MIRAGE&&(A(this.foes,t.rni).special=1)}get size(){return this.conf.cols*this.conf.rows}init(t,e){this.game.wings.push(this);for(let i=0;i<t;i++)new R(this,e(this,i));console.log(this)}onBeat(){this.foes.forEach(t=>this.conf.foeBeat(this.beat,t)),this.beat++}update(t){this.foes.forEach(t=>this.conf.foeThink(t)),this.foes.forEach(e=>e.update(t)),this.foes=this.foes.filter(t=>!t.dead)}}X.W2X=1,X.H2X=2,X.PHALANX=3,X.MIRAGE=4,X.WALL=5,X.SHIELD=6,X.CONTINUOUS=7,X.RANDOM=8,X.phalanxUnlocks=[0,X.H2X,X.WALL,X.MIRAGE,X.SHIELD,X.W2X,X.RANDOM,X.CONTINUOUS],X.skirmishUnlocks=[R.SNIPE,R.FAN,R.WALL,R.STEALTH,R.SHIELD,R.SPAWN,R.CHASE,R.COMM];class j{constructor(t,e){this.canvas=t,this.background=e,this.wings=[],this.scale=1,this.fxScale=.5,this.realtime=!0,this.time=-.001,this.beatTime=0,this.schedule=new m,this.tweens=new v(0),this.beatLength=3,this.beat=0,this.shieldRecharge=[.2,1],this.snakeRecoverRate=.5,this.maxShield=100,this.shieldAnim=1,this.score=0,this.over=!1,this.snakeMinLength=20,this.heat=0,this.complication=0,this.stage=8,this.init()}sendPhalanx(t){new X(this,t,!1)}sendSkirmisher(t){let e=Math.ceil(this.rnf()*this.complication/10);for(let i=0;i<e;i++)new X(this,t,!0)}rnf(){return this.rni()%1e9/1e9}seed(t){var e;this.rni=(e=t,(e%=2147483647)<=0&&(e+=2147483646),()=>e=16807*e%2147483647)}init(){this.seed(15),this.shield=this.maxShield,this.width=this.canvas.clientWidth/this.scale,this.height=this.canvas.clientHeight/this.scale,this.canvas.height=this.height,this.canvas.width=this.width,this.background.height=this.canvas.clientHeight*this.fxScale,this.background.width=this.canvas.clientWidth*this.fxScale,this.ctx=this.canvas.getContext("2d"),this.ctx.globalCompositeOperation="ligher",this.ctb=this.background.getContext("2d"),this.ctx.strokeStyle="white",this.snake=new u(this),this.shots=[],this.foes=[],this.fx=[]}update(t){if(this.over)return;if(!this.mouseAt)return;this.complication=(this.time/60+this.stage-3)*(.5+.5*this.shield/this.maxShield),this.beatLength=80/(20+this.complication);let e=a(this.mouseAt,this.snake.head),i=e>=5;this.lastLoopTimeStamp||(this.lastLoopTimeStamp=t-.001);let s=Math.min(.02,(t-this.lastLoopTimeStamp)/1e3);if(this.shieldAnim=Math.min(1,this.shieldAnim+s),this.shield=Math.min(this.maxShield,this.shield+s*(this.shieldRecharge[0]+(this.shieldRecharge[1]-this.shieldRecharge[0])*(1-this.shield/this.maxShield))),this.lastLoopTimeStamp=t,!this.realtime&&!i)return;e>20&&(s*=e/20);let h=Math.floor((this.time+s)/this.beatLength)!=Math.floor(this.time/this.beatLength);this.time+=s,this.beatTime+=s,this.beatTime>this.beatLength&&(h=!0,this.beatTime-=this.beatLength),this.seed(this.beat),h&&this.beat%9==0&&this.sendPhalanx(this.beat/9),h&&this.beat%5==2&&this.sendSkirmisher(Math.floor(this.beat/5)),this.snake.update(i?this.mouseAt:null,s),this.tweens.update(this.time),this.schedule.update(this.time);for(let t of this.wings)t.update(s),h&&t.onBeat();this.shots=this.shots.filter(t=>t.update(s)),this.wings=this.wings.filter(t=>t.foes.length>0),this.foes=this.foes.filter(t=>!t.dead),this.fx=this.fx.filter(t=>t.update(s)),(this.shield<0||this.snake.length<this.snakeMinLength)&&(this.over=!0),this.draw(),h&&(this.beat++,h&&this.delayed(2,()=>void 0))}toggleTime(){this.realtime=!this.realtime}draw(){this.canvas.style.cursor=this.over?"default":"none",this.ctx.clearRect(0,0,this.width,this.height),this.ctb.clearRect(0,0,this.width,this.height),this.ctx.shadowColor="white",this.ctx.save();let t=this.ctx.createLinearGradient(0,this.height,0,this.height-50);t.addColorStop(0,`rgba(255, 255, 255, ${.002*this.shield*this.shieldAnim})`),t.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,this.height-50,this.width,50),this.ctx.fillStyle="white",this.ctx.font='12pt "Courier"',this.ctx.fillText("SHIELD "+this.shield.toFixed(0),20,this.height-20),this.ctx.fillText("TAIL "+(this.snake.length-this.snakeMinLength).toFixed(0),150,this.height-20),this.ctx.textAlign="right",this.ctx.fillText("SCORE "+this.score,this.width-20,this.height-20),this.ctx.fillText("TIME "+this.time.toFixed(0),this.width-150,this.height-20),this.ctx.fillText("STAGE "+this.stage,this.width-240,this.height-20),this.ctx.restore();for(let t of this.fx)t.draw();for(let t of this.foes)t.draw();for(let t of this.shots)t.draw();this.snake.draw(),this.drawOverText()}drawOverText(){if(!this.over)return;this.ctx.save(),this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.font='24pt "Courier"';let t=null;this.snake.length<this.snakeMinLength?t="Snake is dead":this.shield<0&&(t="Planetary shields depleted");let e=t?"GAME OVER":"FLIGHT OF THE SNAKE";this.ctx.fillText(e,this.width/2,this.height/2),this.ctx.font='12pt "Courier"',t&&this.ctx.fillText(t,this.width/2,this.height/2+20),this.ctx.fillText(`Press S to ${t?"re":""}start`,this.width/2,this.height/2+60),this.ctx.restore()}foeHit(t){let e=this.foes.filter(e=>!e.dying&&!e.phantom&&e.hitTest(t));if(e.length>0){return function(t,e){let i=t.reduce((t,i,s)=>{let h=e(i);return h<t[1]?[s,h]:t},[-1,Number.MAX_VALUE]);return i[0]<0?{ind:-1,item:null,val:null}:{ind:i[0],item:t[i[0]],val:e(t[i[0]])}}(e,e=>a(t,e.at)).item}}delayed(t,e){this.schedule.add(this.time+t,e)}shieldHit(){this.shield>0&&(this.shield-=1),this.shieldAnim=0}complicatedPhalanx(){return this.complication>=this.rni()%20}}let q,_,z=!0;function K(){C=new j(q,_)}return window.onload=function(){q=document.getElementById("canvas-main"),_=document.getElementById("canvas-background"),K(),C.over=!0,C.drawOverText(),q.addEventListener("mousemove",e=>{t.mouseAt=[e.pageX-q.offsetLeft,e.pageY-q.offsetTop],C&&(C.mouseAt=o(t.mouseAt,1/C.scale))},!1),q.addEventListener("mousedown",t=>{C&&C.toggleTime()}),q.addEventListener("mouseleave",t=>{z=!1}),q.addEventListener("mouseenter",t=>{z=!0}),document.addEventListener("keydown",t=>{"KeyS"==t.code&&K()}),function t(e){requestAnimationFrame(i=>{e(i),t(e)})}(t=>{C&&z&&C.update(t)})},t}({});
