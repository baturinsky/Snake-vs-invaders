!function(){"use strict";function t(t){return[Math.round(t[0]),Math.round(t[1])]}function e(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function i(t,e,i=1){return[t[0]+e[0]*i,t[1]+e[1]*i]}function s(t){let e=h(t)||1;return[t[0]/e,t[1]/e]}function h(t,i){return e(i?[t[0]-i[0],t[1]-i[1]]:t)}function a(t,e){return[e[0]-t[0],e[1]-t[1]]}function n(t,e){return t[0]*e[0]+t[1]*e[1]}function r(t,e){return[t[0]*e,t[1]*e]}function o(t,i,h,r){let o=a(i,h),l=[(d=s(o))[1],-d[0]];var d;let c=a(i,t),f=e(o),g=n(o,c)/f,u=n(l,c);return Math.abs(u)<=r&&0<=g&&g<=f}function l(t,e,i=1){let s=h(t,e),a=[];for(let h=0;h<=s;h+=i)a.push(d(t,e,h));return a}function d(t,e,i){return[t[0]*(1-i)+i*e[0],t[1]*(1-i)+i*e[1]]}function c(t){return[Math.cos(t),Math.sin(t)]}class f{constructor(t){this.dots=[],this.length=0,Object.assign(this,t)}updateLength(){this.length=this.dots.reduce((t,e,i)=>0==i?0:t+h(this.dots[i-1],e),0)||0}enlarge(t){let e=this.dots;for(e.push(t),this.updateLength();this.length>this.maxLength||e.length>30;)e.shift(),this.updateLength()}compact(t,e){for(;t.dots.length>=3&&h(t.head,t.dots[t.dots.length-2])<=e;)t.dots.splice(t.dots.length-2,1)}get head(){return this.dots[this.dots.length-1]}draw(e,i){let s=this.dots;e.save(),e.lineCap="round";for(let h=1;h<s.length;h++){let a=s[h],n=s[h-1];e.beginPath(),e.moveTo(...t(n)),i&&i(this,h),e.lineTo(...t(a)),e.stroke()}e.restore()}drawSmooth(t){if(this.dots.length<2)return;let e=this.dots;t.save(),t.beginPath(),t.moveTo(...e[0]),t.lineCap="round";for(let s=1;s<e.length-1;s++){let h=e[s],a=e[s-1],n=r(i(a,h),.5);t.quadraticCurveTo(a[0],a[1],n[0],n[1])}t.quadraticCurveTo(e[e.length-2][0],e[e.length-2][1],e[e.length-1][0],e[e.length-1][1]),t.stroke(),t.restore()}width(t){return 4}hitTest(t){let e=this.dots;for(let i=1;i<e.length;i++){let h=e[i],n=e[i-1];if(o(t,n,h,this.width(4)))return s(a(n,h))}return null}loseHead(){this.dots.length>=3&&(this.dots.pop(),this.updateLength())}}class g{constructor(t){this.game=t,this.hurt=0,this.maxLength=150,this.tail=new f({maxLength:this.maxLength,maxDots:30})}update(t,e){let i;t&&this.tail.enlarge(t);for(let t of this.tail.dots)if(i=this.game.foeHit(t))break;i&&(i.damage(),this.tail.loseHead(),this.tail.maxLength*=.9,this.hurt=1,this.game.delayed(.2,()=>{this.hurt=0})),this.tail.maxLength<=this.maxLength&&(this.tail.maxLength+=e)}draw(){if(this.tail.dots.length<2)return;let t=this.game.ctx;t.save(),this.hurt&&Math.floor(20*this.game.time)%2?(t.strokeStyle="red",t.shadowColor="red"):(t.strokeStyle="white",t.shadowColor="white"),t.shadowBlur=6,t.lineWidth=10,this.tail.drawSmooth(this.game.ctx);let e=this.head;t.lineWidth=0,t.fillStyle=`rgba(255,255,255, ${.2*(1.2+Math.sin(2*this.game.time))})`,t.beginPath(),t.arc(e[0],e[1],10,0,2*Math.PI),t.fill(),t.restore()}get head(){return this.tail.head}}class u{constructor(){this.events=[]}add(t,e){for(let i=this.events.length-1;i>0;i--)if(this.events[i][1]<=t)return void this.events.splice(i+1,0,[e,t]);this.events.splice(0,0,[e,t])}update(t){for(;this.events.length>0&&this.events[0][1]<=t;){let e=this.events.shift(),i=e[0](t);(i||0==i)&&this.add(i+t,e[0])}}}class m{constructor(t,e,i,s,h,a){this.object=t,this.field=e,this.target=i,this.duration=s,this.initialTime=h,this.fun=a,this.initial=t[e]}update(t){let e=(t-this.initialTime)/this.duration;return e>=1?(this.object[this.field]=this.target,this.onEnd&&this.onEnd(),!1):(this.fun&&(e=this.fun(e)),this.object[this.field]=this.initial+(this.target-this.initial)*e,!0)}}class w{constructor(t){this.time=t,this.tweens=[]}update(t){this.time=t,this.tweens=this.tweens.filter(e=>e.update(t))}add(t,e,i,s){let h=new m(t,e,i,s,this.time);return this.tweens.push(h),h}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var v,p=(function(t){function e(){this.setSettings=function(t){for(var e=0;e<24;e++)this[String.fromCharCode(97+e)]=t[e]||0;this.c<.01&&(this.c=.01);var i=this.b+this.c+this.e;if(i<.18){var s=.18/i;this.b*=s,this.c*=s,this.e*=s}}}var i=new function(){var t,i,s,h,a,n,r,o,l,d,c,f;this._params=new e,this.reset=function(){var t=this._params;h=100/(t.f*t.f+.001),a=100/(t.g*t.g+.001),n=1-t.h*t.h*t.h*.01,r=-t.i*t.i*t.i*1e-6,t.a||(c=.5-t.n/2,f=5e-5*-t.o),o=1+t.l*t.l*(t.l>0?-.9:10),l=0,d=1==t.m?0:(1-t.m)*(1-t.m)*2e4+32},this.totalReset=function(){this.reset();var e=this._params;return t=e.b*e.b*1e5,i=e.c*e.c*1e5,s=e.e*e.e*1e5+12,3*((t+i+s)/3|0)},this.synthWave=function(e,g){var u=this._params,m=1!=u.s||u.v,w=u.v*u.v*.1,v=1+3e-4*u.w,p=u.s*u.s*u.s*.1,b=1+1e-4*u.t,M=1!=u.s,k=u.x*u.x,S=u.g,x=u.q||u.r,T=u.r*u.r*u.r*.2,A=u.q*u.q*(u.q<0?-1020:1020),P=u.p?32+((1-u.p)*(1-u.p)*2e4|0):0,y=u.d,I=u.j/2,L=u.k*u.k*.01,E=u.a,C=t,W=1/t,H=1/i,B=1/s,N=5/(1+u.u*u.u*20)*(.01+p);N>.8&&(N=.8),N=1-N;for(var R,O,$,j,q,G,F=!1,D=0,_=0,U=0,z=0,X=0,K=0,V=0,Y=0,J=0,Q=0,Z=new Array(1024),tt=new Array(32),et=Z.length;et--;)Z[et]=0;for(et=tt.length;et--;)tt[et]=2*Math.random()-1;for(et=0;et<g;et++){if(F)return et;if(P&&++J>=P&&(J=0,this.reset()),d&&++l>=d&&(d=0,h*=o),(h*=n+=r)>a&&(h=a,S>0&&(F=!0)),O=h,I>0&&(Q+=L,O*=1+Math.sin(Q)*I),(O|=0)<8&&(O=8),E||((c+=f)<0?c=0:c>.5&&(c=.5)),++_>C)switch(_=0,++D){case 1:C=i;break;case 2:C=s}switch(D){case 0:U=_*W;break;case 1:U=1+2*(1-_*H)*y;break;case 2:U=1-_*B;break;case 3:U=0,F=!0}x&&(($=0|(A+=T))<0?$=-$:$>1023&&($=1023)),m&&v&&((w*=v)<1e-5?w=1e-5:w>.1&&(w=.1)),G=0;for(var it=8;it--;){if(++V>=O&&(V%=O,3==E))for(var st=tt.length;st--;)tt[st]=2*Math.random()-1;switch(E){case 0:q=V/O<c?.5:-.5;break;case 1:q=1-V/O*2;break;case 2:q=.225*(((q=1.27323954*(j=6.28318531*((j=V/O)>.5?j-1:j))+.405284735*j*j*(j<0?1:-1))<0?-1:1)*q*q-q)+q;break;case 3:q=tt[Math.abs(32*V/O|0)]}m&&(R=K,(p*=b)<0?p=0:p>.1&&(p=.1),M?(X+=(q-K)*p,X*=N):(K=q,X=0),z+=(K+=X)-R,q=z*=1-w),x&&(Z[Y%1024]=q,q+=Z[(Y-$+1024)%1024],Y++),G+=q}G*=.125*U*k,e[et]=G>=1?32767:G<=-1?-32768:32767*G|0}return g}},s=function(t){i._params.setSettings(t);var e=i.totalReset(),s=new Uint8Array(4*((e+1)/2|0)+44),h=2*i.synthWave(new Uint16Array(s.buffer,44),e),a=new Uint32Array(s.buffer,0,44);a[0]=1179011410,a[1]=h+36,a[2]=1163280727,a[3]=544501094,a[4]=16,a[5]=65537,a[6]=44100,a[7]=88200,a[8]=1048578,a[9]=1635017060,a[10]=h,h+=44;for(var n=0,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="data:audio/wav;base64,";n<h;n+=3){var l=s[n]<<16|s[n+1]<<8|s[n+2];o+=r[l>>18]+r[l>>12&63]+r[l>>6&63]+r[63&l]}return o};t.exports=s}(v={exports:{}},v.exports),v.exports);function b(t,e=.01){let i=t.slice();i[23]*=.2*Math.random()+.8,i[5]*=Math.random()+.5,function(t){try{var e=p(t),i=new Audio;i.src=e,i.play()}catch(t){console.error(t)}}(i)}new AudioContext;function M(t){b([3,,.0315,,.1484,.496,,-.5938,,,,,,,,,,,1,,,.2325,,.5])}class k{constructor(t){this.game=t,t.fx.push(this)}update(t){return!1}draw(){}}class S{}class x extends k{constructor(t,e,i){super(t),this.at=e,this.life=0,this.particles=[],this.color=[255,255,255],this.arc=2*Math.PI,this.lifeTime=1,this.pnum=30,this.pvel=200,i&&Object.assign(this,i);let s=t.fxScale;for(let t=0;t<this.pnum;t++){let i=new S;this.particles.push(i),i.at=r(e,s);let h=t/this.pnum*Math.PI*2+.1*Math.random(),a=Math.random()*this.pvel;i.vel=r(c(h),a*s)}b([3,,.1238,.3385,.3229,.0203,,.0284,,,,,,,,,.4758,-.0269,1,,,,,.5])}update(t){for(let e of this.particles)e.at=i(e.at,e.vel,t);return this.life+=t/this.lifeTime,this.life<=1}draw(){let t=this.game.ctx;t.save(),t.lineWidth=1,t.strokeStyle=`rgba(${this.color.join()}, 1)`,t.fillStyle=`rgba(${this.color.join()}, ${.5-.5*(this.life||0)})`,t.beginPath(),t.arc(this.at[0],this.at[1],20*(1+2*this.life),0,2*Math.PI),t.stroke(),t.fill(),t.restore();let e=this.game.ctb,i=this.game.fxScale;e.save(),e.lineWidth=2*i,e.fillStyle=`rgba(${this.color[0]}, ${this.color[1]}, ${this.color[2]}, ${1-this.life})`;for(let t of this.particles)e.fillRect(t.at[0],t.at[1],4*i,4*i);e.restore()}}const T=30,A=6;let P=function(t,e){let i=document.createElement("canvas");return i.width=t[0],i.height=t[1],e(i.getContext("2d")),i}([20,20],t=>{t.filter="blur(2px)",t.fillStyle="rgba(255, 255, 255, 0.3)",t.beginPath(),t.arc(10,10,7,0,2*Math.PI),t.fill(),t.fillStyle="rgba(128, 128, 128, 0.6)",t.beginPath(),t.arc(10,10,3,0,2*Math.PI),t.fill()});class y{constructor(t,e,s,h=180){this.game=t,this.bounces=0,t.shots.push(this);let a=[-Math.sin(s),Math.cos(s)];this.tail=new f({dots:[i(e,a,10)],vel:r(a,h),maxLength:T,maxDots:A})}update(t){let s=this.tail,h=s.head;if(h[1]>this.game.height&&(new x(this.game,h,{color:[255,0,0]}),this.game.shieldHit()),h[0]<0||h[1]<0||h[0]>this.game.width||h[1]>this.game.height)return!1;let n,o=i(h,s.vel,t);if(this.bounces>0&&!this.phantom){let t=this.game.foeHit(o);if(t){if(2==t.kind){let e;for(e of l(h,o))if(t.hitTest(e))break;e=e||o;let i=a(t.at,e),s=Math.atan2(i[1],i[0]);s>.25*Math.PI&&s<.75*Math.PI||t.damage()}else t.damage();return!1}}let d,f=this.game.snake.tail;for(d of l(h,o,3))if(n=f.hitTest(d))break;return n?(M(this.tail.head),s.vel=r((g=s.vel,u=n,c(2*Math.atan2(u[1],u[0])+Math.atan2(g[1],-g[0])+Math.PI)),e(s.vel)),s.enlarge(i(d,s.vel,3*t)),this.bounces++,!0):(s.enlarge(o),!0);var g,u}draw(){let e=this.game.ctx;e.save();let i=t(this.tail.head);this.phantom||(e.drawImage(P,i[0]-10,i[1]-10),this.bounces>0&&e.drawImage(P,i[0]-10,i[1]-10)),e.lineWidth=4,e.strokeStyle="#ffdddd",this.tail.draw(e,(t,i)=>{let s=Math.min(i/this.tail.dots.length);e.strokeStyle=`rgb(255, 255, 255, ${s})`}),e.restore()}}class I extends k{constructor(t,e,i){super(t),this.foe=e,this.radius=i,this.time=0}update(t){return this.time+=t,this.time<1}draw(){let t=this.game.ctx;t.save(),t.beginPath(),t.lineWidth=2*(1-this.time),t.strokeStyle="white",t.arc(this.foe.at[0],this.foe.at[1],this.radius*(1+this.time),0,2*Math.PI),t.stroke(),t.restore()}}let L,E=.5,C={4:3,8:4};class W{constructor(t,e){this.wing=t,this.radius=20,this.charge=0,this.chargeTime=2,this.angle=0,this.kind=1,this.special=0,this.shields=0,Object.assign(this,e),this.game=t.game,this.order=t.foes.length,this.game.foes.push(this),t.foes.push(this),this.chargeTime=this.game.beatLength*(C[this.kind]||.5)}draw(){let t=this.game.ctx;if(t.save(),t.strokeStyle="#ffffff",t.translate(this.at[0],this.at[1]),t.scale(this.radius,this.radius),t.rotate(this.angle),!this.dying){t.fillStyle=`rgba(255,255,255,${Math.max(this.charge/2,0)})`,t.shadowColor="white",t.shadowBlur=5,t.lineWidth=.1,[W.MIRAGE,W.STEALTH].includes(this.kind)||(t.beginPath(),t.arc(0,0,1,0,2*Math.PI),t.stroke(),t.fill());for(let e=0;e<this.shields;e++)t.beginPath(),t.arc(0,0,1+.3*(e+1),0,2*Math.PI),t.stroke();t.save(),t.beginPath(),this.drawSignature(t),t.stroke(),t.restore()}if(t.restore(),t.save(),this.kind==W.COMM&&this.charge>.9){t.setLineDash([5,15]);for(let e of this.game.foes)e.kind!=W.COMM&&(t.strokeStyle="white",t.lineWidth=10*(this.charge-.9),t.beginPath(),t.moveTo(...this.at),t.lineTo(...e.at),t.stroke())}t.restore()}drawSignature(t){switch(this.kind){case W.PAWN:return t.moveTo(0,1),void t.lineTo(0,.5);case W.WALL:return t.lineWidth=.2,void t.arc(0,0,.85,.25*Math.PI,.75*Math.PI);case W.SPAWN:if(this.special)return;t.lineWidth=.05;for(let e=0;e<3;e++)t.strokeStyle="black",t.shadowColor="black",t.beginPath(),t.arc(0,.5,.3,0,2*Math.PI),t.stroke(),t.rotate(2*Math.PI/3);return;case W.COMM:t.lineWidth=.05;for(let e=0;e<3;e++)t.beginPath(),t.arc(0,0,.35+.2*e,Math.PI,2*Math.PI),t.stroke();return;case W.FAN:for(let e=-2;e<=2;e++){let i=.3*e;t.moveTo(-Math.sin(i),Math.cos(i)),t.lineTo(.7*-Math.sin(i),.7*Math.cos(i))}return;case W.MIRAGE:return this.phantom&&Math.random()<.005&&(t.strokeStyle="rgba(255,255,255,0.5)"),t.moveTo(0,1),t.lineTo(0,.5),t.stroke(),t.beginPath(),t.arc(0,0,1,0,2*Math.PI),void t.fill();case W.SHIELD:return t.lineWidth=.05,t.beginPath(),t.arc(0,0,.8,0,2*Math.PI),void t.stroke();case W.BOMB:for(let e=0;e<=16;e++)t.moveTo(0,1+.3*this.charge),t.lineTo(0,.7+.3*this.charge),t.rotate(Math.PI/8);return;case W.CHASE:return t.moveTo(-.9,-.4),t.lineTo(0,.45),void t.lineTo(.9,-.4);case W.SNIPE:return t.moveTo(0,-.8),t.lineTo(0,1),t.moveTo(.2,-.8),t.lineTo(.2,1),t.moveTo(-.2,-.8),void t.lineTo(-.2,1)}}actuallyShoot(){switch(this.kind){case W.SPAWN:this.special?new y(this.game,this.at,this.angle):(this.vel[0]=this.vel[0]*(this.game.rni()%2?1:-1),new W(this.wing,{kind:3,at:this.at,vel:[-this.vel[0],this.vel[1]],special:!0}));break;case W.COMM:for(let t of this.game.foes)4!=t.kind&&t.shoot();break;case W.FAN:for(let t=-2;t<=2;t++){let e=.3*t;new y(this.game,this.at,e)}break;case W.MIRAGE:let t=new y(this.game,this.at,this.angle);this.phantom&&(t.phantom=!0);break;case W.BOMB:for(let t=0;t<16;t++)new y(this.game,this.at,Math.PI/8*t,500),this.explode();break;case W.SNIPE:for(let t=-1;t<=1;t++)new y(this.game,i(this.at,c(this.angle),5*t),this.angle,500);break;case W.CHASE:this.vel=r(c(this.angle+Math.PI/2),200);break;default:new y(this.game,this.at,this.angle)}this.charge=0}update(t){if(this.kind==W.CHASE){let t=a(this.at,this.game.snake.head);this.angle=Math.atan2(t[1],t[0])-Math.PI/2}this.dying&&(this.dying+=t/E),this.charge>0&&(this.charge+=t/this.chargeTime,this.charge>=1&&this.actuallyShoot());let e=i(this.at,this.vel,t);this.at=e,this.at[1]<-400&&this.remove()}get dead(){return this.dying>=1}shoot(){this.charge>0||2==this.kind||([1,6,10,11,12].includes(this.kind)&&this.game.tweens.add(this,"angle",.5*(this.game.rnf()-.5),this.chargeTime-.1),this.charge=.01)}remove(){if(this.dying=.01,this.kind==W.MIRAGE&&!this.phantom)for(let t of this.wing.foes)t.phantom&&t.remove()}explode(){this.dying||(this.remove(),new x(this.game,this.at))}hitTest(t){return h(t,this.at)<=this.outerRadius?t:null}get phantom(){return this.kind==W.MIRAGE&&!this.special}damage(){this.shields>0?(new I(this.game,this,this.outerRadius),this.shields--):this.explode()}get outerRadius(){return this.radius*(1+.3*this.shields)}}function H(t,e){let i=t.conf,s=e%i.cols,h=Math.floor(e/i.cols),a=Math.min(40,(t.game.width-200)/i.cols),n=t.ind%2?t.game.width-100-i.cols*a:100,r=i.kind;return"walled"==i.special&&1==r&&h==i.rows-1&&(r=W.WALL),{at:[s*a+n,20-40*i.rows+40*h],vel:[t.ind%2?-10:10,30],shields:0,kind:r}}function B(t,e){let i=t.conf;return{at:[t.game.width/2-20*i.cols,40*Math.floor(e/i.rows)-80],vel:[40*t.game.rnf()-20,30],kind:i.kind}}function N(t,e){let i=e.wing.conf;t%(i.rows+1)!=i.rows&&Math.floor(e.order/i.cols)!=i.rows-t%(i.rows+1)||e.shoot()}function R(t){(t.at[0]<100&&t.vel[0]<0||t.at[0]>=t.wing.game.width-100&&t.vel[0]>0)&&(t.vel[0]=-t.vel[0]),t.at[1]>=t.wing.game.height-300&&t.vel[1]>0&&(t.vel[1]=-t.vel[1])}function O(t){(t.at[0]<100&&t.vel[0]<0||t.at[0]>=t.wing.game.width-100&&t.vel[0]>0)&&(t.vel=[0,0]),(t.at[1]>=t.wing.game.height-100&&t.vel[1]>0||t.at[1]<=100&&t.vel[1]<0)&&(t.vel=[0,0])}W.PAWN=1,W.WALL=2,W.SPAWN=3,W.COMM=4,W.FAN=5,W.MIRAGE=6,W.SHIELD=7,W.BOMB=8,W.CHASE=9,W.SNIPE=10,W.STEALTH=11,W.SNAKE=12;class ${constructor(t,e){var i,s;this.game=t,this.ind=e,this.foes=[],this.beat=0,e>=0?(this.conf={cols:6,rows:3,kind:1,init:H,foeBeat:N,foeThink:R},e%5==5&&(this.conf.special="armored"),this.conf.kind==W.MIRAGE&&(this.foes[Math.floor(Math.random()*this.size)].special=1)):(this.conf={cols:1,rows:1,kind:(i=[W.SPAWN,W.FAN,W.SNIPE,W.BOMB,W.CHASE],s=t.rni,i[s()%i.length]),init:B,foeBeat:N,foeThink:R},this.conf.kind==W.CHASE&&(this.conf.foeThink=O)),this.init(this.size,this.conf.init)}get size(){return this.conf.cols*this.conf.rows}init(t,e){this.game.wings.push(this);for(let i=0;i<t;i++)new W(this,e(this,i));console.log(this)}onBeat(t){this.foes.forEach(t=>this.conf.foeBeat(this.beat,t)),this.beat++}update(t){this.foes.forEach(t=>this.conf.foeThink(t)),this.foes.forEach(e=>e.update(t)),this.foes=this.foes.filter(t=>!t.dead)}}class j{constructor(){this.wings=[],this.scale=1,this.fxScale=.5,this.realtime=!1,this.time=-.001,this.schedule=new u,this.tweens=new w(0),this.beatLength=3,this.beat=0,this.shield=100,this.shieldAnim=1}sendWing(t){new $(this,t)}sendSmallwing(t){new $(this,t)}rnf(){return this.rni()%1e9/1e9}init(){var t;this.rni=(t=15,(t%=2147483647)<=0&&(t+=2147483646),()=>t=16807*t%2147483647),this.canvas=document.getElementById("canvas-main"),this.background=document.getElementById("canvas-background"),this.width=this.canvas.clientWidth/this.scale,this.height=this.canvas.clientHeight/this.scale,this.canvas.height=this.height,this.canvas.width=this.width,this.background.height=this.canvas.clientHeight*this.fxScale,this.background.width=this.canvas.clientWidth*this.fxScale,this.ctx=this.canvas.getContext("2d"),this.ctx.globalCompositeOperation="ligher",this.ctb=this.background.getContext("2d"),this.ctx.strokeStyle="white",this.snake=new g(this),this.shots=[],this.foes=[],this.fx=[],this.startLoop()}loop(t){if(!this.mouseAt)return;let e=h(this.mouseAt,this.snake.head),i=e>=5;this.lastLoopTimeStamp||(this.lastLoopTimeStamp=t-.001);let s=Math.min(.02,(t-this.lastLoopTimeStamp)/1e3);if(this.shieldAnim=Math.min(1,this.shieldAnim+s),this.shield=Math.min(100,this.shield+s),this.lastLoopTimeStamp=t,!this.realtime&&!i)return;e>20&&(s*=e/20);let a=Math.floor((this.time+s)/this.beatLength)!=Math.floor(this.time/this.beatLength);this.time+=s,a&&this.beat%9==0&&this.sendWing(this.beat/9),a&&this.beat%4==2&&this.sendSmallwing(-1-Math.floor(this.beat/4)),this.snake.update(i?this.mouseAt:null,s),this.tweens.update(this.time),this.schedule.update(this.time);for(let t of this.wings)t.update(s),a&&t.onBeat(this.beat);this.shots=this.shots.filter(t=>t.update(s)),this.wings=this.wings.filter(t=>t.foes.length>0),this.foes=this.foes.filter(t=>!t.dead),this.fx=this.fx.filter(t=>t.update(s)),this.draw(),a&&(this.beat++,a&&this.delayed(2,()=>void 0))}startLoop(){this.canvas.addEventListener("mousemove",t=>{this.mouseAt=[(t.pageX-this.canvas.offsetLeft)/this.scale,(t.pageY-this.canvas.offsetTop)/this.scale]},!1),this.canvas.addEventListener("mousedown",t=>{console.log(this),this.realtime=!this.realtime}),requestAnimationFrame(t=>{!function t(e){requestAnimationFrame(i=>{e(i),t(e)})}(t=>this.loop(t))})}draw(){this.ctx.clearRect(0,0,this.width,this.height),this.ctb.clearRect(0,0,this.width,this.height),this.ctx.shadowColor="white";let t=this.ctx.createLinearGradient(0,this.height,0,this.height-50);t.addColorStop(0,`rgba(255, 255, 255, ${.002*this.shield*this.shieldAnim})`),t.addColorStop(1,"rgba(255, 255, 255, 0)"),this.ctx.fillStyle=t,this.ctx.fillRect(0,this.height-50,this.width,50);for(let t of this.fx)t.draw();for(let t of this.foes)t.draw();for(let t of this.shots)t.draw();this.snake.draw()}foeHit(t){let e=this.foes.filter(e=>!e.dying&&!e.phantom&&e.hitTest(t));if(e.length>0){return function(t,e){let i=t.reduce((t,i,s)=>{let h=e(i);return h<t[1]?[s,h]:t},[-1,Number.MAX_VALUE]);return i[0]<0?{ind:-1,item:null,val:null}:{ind:i[0],item:t[i[0]],val:e(t[i[0]])}}(e,e=>h(t,e.at)).item}}delayed(t,e){this.schedule.add(this.time+t,e)}shieldHit(){this.shield>0&&(this.shield-=1),this.shieldAnim=0}}window.onload=function(){(L=new j).init()}}();
